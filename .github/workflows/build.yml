name: CI/CD

on:
  push:
    branches: [main, dev]
    tags:
      - "v*.*.*"
    pull_request:
      branches: [dev]

jobs:
  quality:
    name: Code Quality
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync

      - name: Type checking
        run: uv run ty check

      - name: Lint
        run: uv run ruff check

      - name: Format check
        run: uv run ruff format --check

  build:
    name: Build with Nuitka
    needs: quality
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync

      - name: Extract version from tag
        id: version
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $version = $tag -replace '^v', ''

          if ($version -match '^(\d+)\.(\d+)\.(\d+)$') {
            $major = $matches[1]
            $minor = $matches[2]
            $patch = $matches[3]

            echo "VERSION=$version" >> $env:GITHUB_OUTPUT
            echo "MAJOR=$major" >> $env:GITHUB_OUTPUT
            echo "MINOR=$minor" >> $env:GITHUB_OUTPUT
            echo "PATCH=$patch" >> $env:GITHUB_OUTPUT

            Write-Host "Version detected: $version (Major: $major, Minor: $minor, Patch: $patch)"
          } else {
            Write-Host "Invalid version format: $version"
            exit 1
          }

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirement.txt
          pip install nuitka ordered-set zstandard

      - name: Install MinGW64
        shell: pwsh
        run: |
          choco install mingw -y
          refreshenv

      - name: Build with Nuitka
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"

          # Exécuter le builder.ps1 avec les paramètres
          .\builder.ps1 `
            -MainFile "src\main.py" `
            -OutputName "autoswitchtheme" `
            -IconFile "assets\icon.ico" `
            -CompanyName "NOVENTARIS" `
            -ProductName "AutoSwitchTheme" `
            -Version $version `
            -Standalone `
            -DisableConsole `
            -Execute `
            -DataFiles "assets"

      - name: Verify build output
        shell: pwsh
        run: |
          # En mode standalone, Nuitka crée un dossier
          $buildFolder = "autoswitchtheme.dist"

          if (Test-Path $buildFolder) {
            Write-Host "Build folder found: $buildFolder"
            $exePath = "$buildFolder\autoswitchtheme.exe"

            if (Test-Path $exePath) {
              $size = [math]::Round((Get-Item $exePath).Length / 1MB, 2)
              Write-Host "Executable built successfully: $exePath ($size MB)"
            } else {
              Write-Host "Executable not found in build folder"
              exit 1
            }
          } else {
            Write-Host "Build failed: Build folder not found"
            exit 1
          }

      - name: Install Inno Setup
        shell: pwsh
        run: |
          Write-Host "Installing Inno Setup..."
          choco install innosetup -y
          refreshenv

          # Verify installation
          $isccPath = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
          if (Test-Path $isccPath) {
            Write-Host "Inno Setup installed successfully"
          } else {
            Write-Host "Inno Setup installation failed"
            exit 1
          }

      - name: Create installer with Inno Setup
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          $isccPath = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"

          # Update version in Inno Setup script
          $issContent = Get-Content "build_installer.iss" -Raw
          $issContent = $issContent -replace '#define MyAppVersion ".*"', "#define MyAppVersion `"$version`""
          $issContent | Set-Content "build_installer.iss" -NoNewline

          Write-Host "Building installer with Inno Setup..."
          & $isccPath "build_installer.iss"

          if ($LASTEXITCODE -ne 0) {
            Write-Host "Inno Setup compilation failed with exit code: $LASTEXITCODE"
            exit $LASTEXITCODE
          }

          # Verify installer was created
          $installerPattern = "autoswitchtheme.setup\auto-switch-theme_*_x86.exe"
          $installer = Get-ChildItem $installerPattern | Select-Object -First 1

          if ($installer) {
            $size = [math]::Round($installer.Length / 1MB, 2)
            Write-Host "Installer created successfully: $($installer.Name) ($size MB)"

            # Rename to standard naming convention
            $newName = "AutoSwitchTheme-$version-Setup.exe"
            Copy-Item $installer.FullName -Destination $newName
            echo "INSTALLER_NAME=$newName" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "Installer not found after compilation"
            exit 1
          }

      # SIGNPATH INTEGRATION - Uncomment after SignPath Foundation approval
      # - name: Sign installer with SignPath
      #   shell: pwsh
      #   run: |
      #     # Install SignPath PowerShell module
      #     Write-Host "Installing SignPath module..."
      #     Install-Module -Name SignPath -Force -Scope CurrentUser -AllowClobber
      #
      #     # Submit for signing
      #     Write-Host "Submitting installer for signing..."
      #     Submit-SigningRequest `
      #       -OrganizationId "${{ secrets.SIGNPATH_ORGANIZATION_ID }}" `
      #       -ProjectSlug "${{ secrets.SIGNPATH_PROJECT_SLUG }}" `
      #       -ApiToken "${{ secrets.SIGNPATH_API_TOKEN }}" `
      #       -InputArtifactPath "${{ steps.create_installer.outputs.INSTALLER_NAME }}" `
      #       -OutputArtifactPath "AutoSwitchTheme-${{ steps.version.outputs.VERSION }}-Setup-Signed.exe" `
      #       -WaitForCompletion
      #
      #     if ($LASTEXITCODE -eq 0) {
      #       Write-Host "Installer signed successfully"
      #       echo "SIGNED_INSTALLER=AutoSwitchTheme-${{ steps.version.outputs.VERSION }}-Setup-Signed.exe" >> $env:GITHUB_OUTPUT
      #     } else {
      #       Write-Host "Signing failed with exit code: $LASTEXITCODE"
      #       exit $LASTEXITCODE
      #     }

      - name: Create portable archive (optional)
        shell: pwsh
        run: |
          # Create a portable ZIP version for users who prefer not to use installers
          $version = "${{ steps.version.outputs.VERSION }}"
          $archiveName = "AutoSwitchTheme-$version-Portable.zip"

          Compress-Archive -Path "autoswitchtheme.dist\*" -DestinationPath $archiveName -Force

          if (Test-Path $archiveName) {
            $size = [math]::Round((Get-Item $archiveName).Length / 1MB, 2)
            Write-Host "Portable archive created: $archiveName ($size MB)"
            echo "ARCHIVE_NAME=$archiveName" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "Warning: Failed to create portable archive"
          }

      - name: Calculate SHA256 hashes
        id: hashes
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          $setupFile = "AutoSwitchTheme-$version-Setup.exe"
          $zipFile = "AutoSwitchTheme-$version-Portable.zip"

          # Calculate SHA256 for installer
          if (Test-Path $setupFile) {
            $setupHash = (Get-FileHash -Path $setupFile -Algorithm SHA256).Hash
            Write-Host "SHA256 ($setupFile): $setupHash"
            echo "SETUP_SHA256=$setupHash" >> $env:GITHUB_OUTPUT
          }

          # Calculate SHA256 for portable archive
          if (Test-Path $zipFile) {
            $zipHash = (Get-FileHash -Path $zipFile -Algorithm SHA256).Hash
            Write-Host "SHA256 ($zipFile): $zipHash"
            echo "ZIP_SHA256=$zipHash" >> $env:GITHUB_OUTPUT
          }

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            AutoSwitchTheme-${{ steps.version.outputs.VERSION }}-Setup.exe
            AutoSwitchTheme-${{ steps.version.outputs.VERSION }}-Portable.zip
          tag_name: ${{ github.ref_name }}
          name: Release ${{ steps.version.outputs.VERSION }}
          body: |
            ## AutoSwitchTheme ${{ steps.version.outputs.VERSION }}

            Automatically switch between light and dark Windows themes based on sunrise and sunset times.

            ### Downloads

            **Installer (Recommended):**
            - [AutoSwitchTheme-${{ steps.version.outputs.VERSION }}-Setup.exe](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/AutoSwitchTheme-${{ steps.version.outputs.VERSION }}-Setup.exe)
            - SHA256: `${{ steps.hashes.outputs.SETUP_SHA256 }}`

            **Portable Version:**
            - [AutoSwitchTheme-${{ steps.version.outputs.VERSION }}-Portable.zip](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/AutoSwitchTheme-${{ steps.version.outputs.VERSION }}-Portable.zip)
            - SHA256: `${{ steps.hashes.outputs.ZIP_SHA256 }}`

            ### Security Notice

            **IMPORTANT: Verify the SHA256 hash before running the installer**

            This application is NOT code signed. To ensure you downloaded the authentic file:

            1. Calculate the SHA256 hash of the downloaded file:
               ```powershell
               Get-FileHash -Algorithm SHA256 "AutoSwitchTheme-${{ steps.version.outputs.VERSION }}-Setup.exe"
               ```

            2. Compare the output with the SHA256 hash listed above
            3. They must match exactly

            **Windows SmartScreen Warning:**

            You will see a "Windows protected your PC" warning when running the installer. This is expected because:
            - Code signing certificates cost $300-500/year for individual developers
            - This is a free, open-source project with zero budget
            - The application is safe - all source code is publicly available

            To proceed:
            1. Verify the SHA256 hash first (see above)
            2. Click "More info" on the SmartScreen warning
            3. Click "Run anyway"

            For more details, see [GUIDE_SIGNATURE.md](https://github.com/${{ github.repository }}/blob/main/docs/GUIDE_SIGNATURE.md).

            ### Installation Instructions

            **Method 1: Installer (Recommended)**
            1. Download and verify SHA256 hash of `AutoSwitchTheme-${{ steps.version.outputs.VERSION }}-Setup.exe`
            2. Run the installer
            3. Follow the installation wizard
            4. Launch AutoSwitchTheme from the Start Menu

            **Method 2: Portable**
            1. Download and verify SHA256 hash of `AutoSwitchTheme-${{ steps.version.outputs.VERSION }}-Portable.zip`
            2. Extract the archive
            3. Run `autoswitchtheme.exe`

            ### System Requirements

            - Windows 10 or Windows 11 (64-bit)
            - Internet connection (first run only, for location detection)

            ### Changes

            See the [commit history](https://github.com/${{ github.repository }}/commits/${{ github.ref_name }}) for details.

            ### Build Information

            - Build process: Automated via GitHub Actions
            - Build logs: [View logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - Source code: Publicly available in this repository

            ---

            **Future plans:** Working on obtaining a free code signing certificate through [SignPath Foundation](https://signpath.org/) to eliminate SmartScreen warnings.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
